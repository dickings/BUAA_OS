#### 思考题1

**请思考cache用虚拟地址来查询的可能性，并且给出这种方式对访存带来的好处和坏处。另外，你能否能根据前一个问题的解答来得出用物理地址来查询的优势?**

用虚拟地址访问cache，在命中时会极大提高速率，若未命中速率较物理地址访存慢。物理地址访存优势在于时间较为稳定。



#### 思考题2

**请查阅相关资料，针对我们提出的疑问，给出一个上述流程的优化版本，新的版本需要有更快的访存效率。（提示：考虑并行执行某些步骤）**

在TLB未命中后执行根据虚拟存储访问cache的步骤，若未命中则在执行MMU翻译。



#### 思考题3

**我们的实验中，有许多对虚拟地址或者物理地址操作的宏函数(详见include/mmu.h ),那么我们在调用这些宏的时候需要弄清楚需要操作的地址是物理地址还是虚拟地址，阅读下面的代码，指出x是一个物理地址还是虚拟地址。**

为虚拟地址，通过C语言指针能直接访问到的都是虚拟地址



#### 思考题4

**我们在 include/queue.h 中定义了一系列的宏函数来简化对链表的操作。实际上，我们在 include/queue.h 文件中定义的链表和 glibc 相关源码较为相似，这一链表设计也应用于 Linux 系统中 (sys/queue.h 文件)。请阅读这些宏函数的代码，说说它们的原理和巧妙之处。**

原理：每个Page都有两个指针next和pre，next指向后面的页，pre指向前面的页的next。这样设计的巧妙之处在于每个Page项其实只能够改变前面一项的next，而不会破坏其他数据。



#### 思考题5

**我们注意到我们把宏函数的函数体写成了 do { /\* ... \*/ } while(0)的形式，而不是仅仅写成形如 { /\* ... \*/ } 的语句块，这样的写法好处是什么？**

这样相当于函数调用一样,加分号不会出现问题。



#### 思考题6

**注意，我们定义的 Page 结构体只是一个信息的载体，它只代表了相应物理内存页的信息，它本身并不是物理内存页。 那我们的物理内存页究竟在哪呢？Page 结构体又是通过怎样的方式找到它代表的物理内存页的地址呢？ 请你阅读 include/pmap.h 与 mm/pmap.c 中相关代码，给出你的想法。**

通过page2pa、page2kva,pa2page等函数能够实现page指针到地址间的转换,主要原理利用page连续存储的性质，page和page头的差值通可反应为实际地址位置。



#### 思考题7

**请阅读 include/queue.h 以及 include/pmap.h, 将Page\_list的结构梳理清楚,选择正确的展开结构(请注意指针)。**

C



#### 思考题8

**在 mmu.h 中定义了 bzero(void \*b, size_t) 这样一个函数,请你思考，此处的b指针是一个物理地址， 还是一个虚拟地址呢？**

此处是一个虚拟地址



#### 思考题9

**了解了二级页表页目录自映射的原理之后，我们知道，Win2k内核的虚存管理也是采用了二级页表的形式，其页表所占的 4M 空间对应的虚存起始地址为 0xC0000000，那么，它的页目录的起始地址是多少呢？**

其实地址为0xC0300000

#### 思考题10

**注意到页表在进程地址空间中连续存放，并线性映射到整个地址空间，思考：是否可以由虚拟地址直接得到对应页表项的虚拟地址？上一节末尾所述转换过程中，第一步查页目录有必要吗，为什么？**

未必，对于有多级页表，页目录以下页表在一个物理页内连续，但是可能在多个不联系物理页上。



#### 思考题11

**思考一下tlb_out 汇编函数，结合代码阐述一下跳转到NOFOUND的流程？从MIPS手册中查找tlbp和tlbwi指令，明确其用途，并解释为何第10行处指令后有4条nop指令。**

tlbp后会填入INDEX，如果不间隔4条指令直接读取会导致竞争和冒险，读到错误的数据。



#### 思考题12

**显然，运行后结果与我们预期的不符，va值为0x88888，相应的pa中的值为0。这说明我们的代码中存在问题，请你仔细思考我们的访存模型，指出问题所在。**

*va = 0x8888,是在C语言运行环境下，通过C语言虚拟地址直接修改的。在整个环境中，并没有所谓的“实地址”，所有的直接修改都是通过C语言虚地址访问的。

#### 思考题13

**在X86体系结构下的操作系统，有一个特殊的寄存器CR4，在其中有一个PSE位，当该位设为1时将开启4MB大物理页面模式，请查阅相关资料，说明当PSE开启时的页表组织形式与我们当前的页表组织形式的区别。**

PSE开启时，虚拟地址前10位仍然通过CR3访问页目录项，然而后22位直接表示偏移，对应于4MB内存，其实地址存储在页目录对应项内。PSE未开启时，则与一般访存无异。





#### 我认为的难点

1.在C语言环境下直接通过虚地址可以访问，与正常实地址为本的思路有所不同，在观看代码过程中容易造成混淆。

2.C语言代码与汇编之间的桥梁还没没建立起来，不太清楚C语言环境虚拟地址与实际地址的关系



#### 我的心得体会

对于虚拟内存有了更深的体会，指导了物理页面如何管理（链表新写法get）。对于用户态和内核态以及它们之间的转换有了深刻理解。



